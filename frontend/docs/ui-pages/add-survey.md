# Страница добавления опроса

## Назначение
Добавление нового опроса (Google Form) в систему для сбора ответов.

## Путь
`/add-survey`

## Доступ
- Только для авторизованных пользователей
- Требуется подключенный Google аккаунт

---

## Структура страницы

### Шапка
- Кнопка "Назад" (←)
- Заголовок: "Добавить опрос"
- (Опционально) Иконка помощи (?)

### Основной контент (Форма)

**Прокручиваемая форма с секциями:**

---

#### 1. Google аккаунт

**Если нет подключенных аккаунтов:**
- Alert/Banner:
  - "Подключите Google аккаунт для добавления опросов"
  - Кнопка: "Подключить Google аккаунт"
  - После подключения → возврат на эту страницу

**Если есть подключенные аккаунты:**
- Label: "Google аккаунт"
- Select / Dropdown:
  - Показываем аватарку + email
  - Выбран основной по умолчанию
  - Можно переключить
- Ссылка: "+ Подключить другой аккаунт"

---

#### 2. Ссылка на Google Form (обязательно)

- Label: "Ссылка на Google Форму"
- Input (URL):
  - Placeholder: "https://forms.gle/..."
  - Type: url
  - Required
- Helper text: "Форма должна быть доступна с выбранного аккаунта"
- Валидация:
  - Формат URL
  - Домен: forms.google.com или forms.gle

**После ввода ссылки и потери фокуса:**
- Автоматическая проверка (API запрос)
- Loading индикатор
- **Успех:**
  - ✅ Зеленая галочка
  - "Форма найдена"
  - Подтягиваем название (если возможно)
- **Ошибка:**
  - ❌ "Нет доступа к форме с этого аккаунта"
  - ❌ "В форме не включен сбор email адресов"
  - ❌ "Неверная ссылка"

---

#### 3. Название опроса (опционально)

- Label: "Название (опционально)"
- Input:
  - Placeholder: "Автоматически из Google Формы"
  - Можно переопределить
  - Max length: 200

---

#### 4. Описание (опционально)

- Label: "Описание (опционально)"
- Textarea:
  - Placeholder: "Краткое описание опроса"
  - Max length: 500
  - Rows: 3

---

#### 5. Категория (опционально, если реализовано)

- Label: "Категория"
- Select:
  - "Без категории"
  - "Образование"
  - "Здоровье"
  - "Образ жизни"
  - и т.д.

---

#### 6. Критерии респондентов (опционально)

**Toggle:** "Установить критерии для респондентов"

**Если включено:**

**Возраст:**
- От: number input (min: 0)
- До: number input (max: 100)

**Пол:**
- Чекбоксы: Мужской | Женский | Другой
- Или: "Не важно"

**Занятость:**
- Select multiple:
  - Студент
  - Работающий
  - Безработный
  - Пенсионер

**Доход:**
- Select:
  - Не важно
  - < 20,000
  - 20,000 - 50,000
  - 50,000 - 100,000
  - > 100,000

**Семейное положение:**
- Select: Не важно | Холост/не замужем | Женат/замужем | В отношениях

**Специальность работы:**
- Text input (опционально)

**Локация:**
- Text input / Select регионов (опционально)

**Checkbox:**
- ☑️ "Разрешить прохождение всем (игнорировать критерии)"
  - Если включено, критерии не применяются жестко

---

#### 7. Награда за прохождение

**Автоматический расчет:**
- Бекенд рассчитывает минимальную награду
- Показываем: "Минимальная награда: **X баллов**"
- Helper text: "Рассчитано на основе количества вопросов"

**Увеличение награды (опционально):**
- Label: "Увеличить награду до"
- Number input:
  - Min: X (минимальная награда)
  - Step: 1
  - Placeholder: X
- Helper text: "Чем выше награда, тем быстрее соберете ответы"

---

#### 8. Количество ответов

**Нужное количество ответов:**
- Label: "Сколько ответов нужно собрать?"
- Number input:
  - Min: 1
  - Placeholder: "Например, 100"
  - Опционально (можно оставить пустым = без ограничения)

**Макс. ответов от одного пользователя:**
- Label: "Макс. ответов от одного пользователя"
- Number input:
  - Min: 1
  - Default: 1
  - Placeholder: "1"

---

#### 9. Расчет стоимости

**Показываем карточку с расчетом:**
- Награда за 1 ответ: Y баллов
- × Количество ответов: Z
- **= Итого: Y × Z баллов**

**Проверка баланса:**
- Ваш баланс: W баллов

**Статусы:**
- ✅ **Достаточно баллов** (W >= Y × Z)
- ⚠️ **Warning:** "У вас недостаточно баллов для указанного количества респондентов. Опрос будет создан, но сможет получить только N ответов" (W < Y × Z, но W >= Y)
- ❌ **Ошибка:** "Недостаточно баллов для создания опроса. Заработайте еще X баллов" (W < Y)
  - Кнопка: "Заработать баллы" → `/`

---

### Кнопки действий (внизу)

- Кнопка "Отмена" (outlined) → возврат назад
- Кнопка "Добавить опрос" (primary)
  - Disabled пока:
    - Не выбран Google аккаунт
    - Не указана ссылка
    - Ссылка не валидирована
    - Недостаточно баллов для минимум 1 ответа

---

## Состояния

### 1. Начальное состояние
- Форма пуста
- Выбран основной Google аккаунт (если есть)
- Кнопка "Добавить" disabled

### 2. Заполнение формы
- Валидация полей при потере фокуса
- Автоматический расчет минимальной награды после проверки ссылки
- Динамический расчет стоимости

### 3. Проверка ссылки (Loading)
- Показываем loader рядом с полем ссылки
- "Проверка ссылки..."

### 4. Ссылка проверена успешно
- ✅ Зеленая галочка
- Подтянуто название (если возможно)
- Рассчитана минимальная награда
- Кнопка "Добавить" активна (если достаточно баллов)

### 5. Ошибка проверки ссылки
- ❌ Красная иконка
- Сообщение об ошибке под полем
- Кнопка "Добавить" disabled
- Можно исправить и проверить снова

### 6. Отправка формы (Loading)
- Кнопка "Добавить опрос" показывает loader
- Текст: "Создание опроса..."
- Форма disabled

### 7. Успех
- Snackbar: "Опрос успешно добавлен!"
- Списание баллов
- Redirect на `/my-surveys`

### 8. Ошибка создания
- Alert с описанием ошибки
- Форма снова активна
- Можно исправить и попробовать снова

---

## Валидация

### Ссылка на Google Form
**Клиентская:**
- Не пустая
- Формат URL
- Домен: forms.google.com или forms.gle

**Серверная:**
- Доступ с выбранного Google аккаунта
- Включен сбор email адресов
- Форма существует

### Награда
- Не меньше минимальной
- Целое число

### Количество ответов
- Целое положительное число
- Или пусто (без ограничения)

---

## Адаптация для Desktop

- Форма в центре (max-width: 600px)
- Две колонки для некоторых полей (возраст от-до, и т.д.)
- Расчет стоимости в боковой панели справа

---

## UI компоненты
- `TextField` - текстовые поля
- `Select` - выбор из списка
- `Checkbox` / `Toggle`
- `NumberInput` - ввод чисел
- `Button` (Primary, Outlined)
- `Alert` / `Banner` - предупреждения
- `GoogleAccountSelector` - выбор Google аккаунта
- `LoadingSpinner` - загрузка
- `CostCalculator` - карточка с расчетом

---

## Технические детали

### API проверка ссылки
```json
POST /api/surveys/validate
{
  "google_account_id": 1,
  "form_url": "https://forms.gle/..."
}
```

**Ответ (успех):**
```json
{
  "valid": true,
  "title": "Опрос о питании студентов",
  "questions_count": 10,
  "estimated_time": 5,
  "min_reward": 10
}
```

**Ответ (ошибка):**
```json
{
  "valid": false,
  "error": "no_access",
  "message": "Нет доступа к форме с этого аккаунта"
}
```

### API создание опроса
```json
POST /api/surveys
{
  "google_account_id": 1,
  "form_url": "https://forms.gle/...",
  "title": "Опрос о питании",
  "description": "Короткий опрос...",
  "category": "lifestyle",
  "criteria": {
    "age_min": 18,
    "age_max": 25,
    "gender": ["male", "female"],
    "employment": ["student"],
    "allow_all": false
  },
  "reward": 15,
  "responses_needed": 100,
  "max_responses_per_user": 1
}
```

**Ответ (успех):**
```json
{
  "survey": {
    "id": 10,
    "title": "Опрос о питании",
    "status": "active",
    "reward": 15,
    "responses_needed": 100,
    "spent_points": 1500
  },
  "new_balance": 8500
}
```

**Ответ (ошибка):**
```json
{
  "error": "insufficient_balance",
  "message": "Недостаточно баллов",
  "required": 1500,
  "current": 1000
}
```

---

## Подсказки и помощь

**Иконка "?" в шапке:**
- Открывает Bottom Sheet с подсказками:
  - Как создать Google Form
  - Как включить сбор email
  - Как настроить доступ
  - FAQ

**Helper texts под полями:**
- Краткие пояснения к каждому полю
- Примеры

---

## Примечания
- Форма должна быть простой и интуитивной
- Большинство полей опциональны
- Фокус на обязательных: Google аккаунт + ссылка
- Автоматический расчет награды упрощает процесс
- Четкая обратная связь по балансу баллов
