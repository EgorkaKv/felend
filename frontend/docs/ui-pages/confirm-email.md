# Страница подтверждения email

## Назначение
Информирование пользователя о необходимости подтвердить email после регистрации.

## Путь
`/confirm-email`

## Доступ
- Открыта для всех
- Обычно попадают сюда после регистрации
- Email передается через state или query параметр

---

## Структура страницы

### Визуал
- Иллюстрация: письмо/конверт с кодом
- Или иконка email (большая, по центру)

### Основной контент

**Заголовок:**
- "Подтвердите email"

**Описание:**
- "Мы отправили код подтверждения на адрес:"
- **{user_email}** (выделен, bold)
- "Введите 6-значный код из письма"

**Поле ввода кода:**
- 6 отдельных полей для каждой цифры (PIN-style input)
- Или одно поле с маской "_ _ _ _ _ _"
- Автофокус на первое поле
- Автоматический переход к следующему полю при вводе
- Крупный шрифт для видимости

**Дополнительная информация:**
- "Не пришло письмо? Проверьте папку Спам"
- "Код действителен 10 минут"

**Действия:**

1. **Кнопка "Подтвердить"**
   - Стиль: primary
   - Полная ширина
   - Активна только когда введены все 6 цифр
   - Автоматическая отправка при вводе 6-й цифры (опционально)

2. **Кнопка "Отправить код повторно"**
   - Стиль: text/link
   - По центру под основной кнопкой
   - С таймером (disabled 60 сек после отправки)

3. **Ссылка "Изменить email"**
   - Текстовая ссылка, по центру
   - Переход на страницу изменения email

---

## Состояния

### 1. Начальное состояние
- Показываем email пользователя
- Поля для ввода кода пустые
- Кнопка "Подтвердить" disabled
- Кнопка "Отправить код повторно" активна (или с таймером если только что зарегистрировались)

### 2. Ввод кода
- Пользователь вводит цифры
- Автоматический переход между полями
- Валидация: только цифры
- Кнопка "Подтвердить" активируется при заполнении всех 6 полей

### 3. Проверка кода (Loading)
- Кнопка "Подтвердить" показывает loader
- Текст: "Проверка..."
- Поля ввода disabled
- Отправка кода на бекенд

### 4. Успех - код верный ✅
- Snackbar: "Email подтвержден!"
- Получаем access и refresh tokens
- Сохраняем токены
- Автоматический redirect на `/` (главную)
- Пользователь залогинен

### 5. Ошибка - неверный код ❌
- Поля ввода подсвечиваются красным
- Анимация "тряски" полей
- Snackbar/текст ошибки: "Неверный код. Попробуйте снова"
- Поля очищаются
- Фокус на первом поле
- Можно ввести снова

### 6. Ошибка - код истек ⏰
- Snackbar: "Код истек. Запросите новый код"
- Поля очищаются
- Кнопка "Отправить код повторно" выделяется

### 7. Код отправлен повторно
- Snackbar: "Новый код отправлен на {email}"
- Поля очищаются
- Кнопка "Отправить повторно" disabled на 60 секунд
- Таймер: "Отправить повторно через X сек"

### 8. Ошибка отправки кода
- Snackbar: "Ошибка отправки кода. Попробуйте позже"
- Кнопка "Отправить повторно" снова активна

---

## Процесс подтверждения email

### Общий flow:
1. **Регистрация** → Бекенд возвращает специальный `confirmation_token`
2. **Запрос кода** → Frontend отправляет `confirmation_token` на эндпоинт
3. **Письмо с кодом** → Бекенд отправляет 6-значный код на email
4. **Ввод кода** → Пользователь вводит код на странице
5. **Подтверждение** → Код отправляется на бекенд
6. **Успех** → Возвращаются access и refresh tokens, пользователь залогинен

---

### 1. После регистрации

**API ответ при регистрации:**
```json
POST /api/auth/register
{
  "email": "user@example.com",
  "password": "password123"
}

// Ответ:
{
  "message": "Пользователь создан",
  "email": "user@example.com",
  "confirmation_token": "temp_token_abc123"
}
```

**Frontend:**
- Сохраняет `confirmation_token` (в state или localStorage)
- Redirect на `/confirm-email?email=user@example.com`
- Сразу отправляет запрос на получение кода

---

### 2. Запрос кода подтверждения

**API запрос:**
```json
POST /api/auth/request-confirmation-code
{
  "confirmation_token": "temp_token_abc123"
}
```

**Ответ (успех):**
```json
{
  "message": "Код отправлен на email",
  "expires_in": 600  // 10 минут в секундах
}
```

**Письмо на email:**
- От: Felend <noreply@felend.app>
- Тема: "Код подтверждения Felend"
- Содержание:
  ```
  Ваш код подтверждения:
  
  1 2 3 4 5 6
  
  Код действителен 10 минут.
  
  Если вы не регистрировались на Felend, проигнорируйте это письмо.
  ```

---

### 3. Ввод и проверка кода

**API запрос подтверждения:**
```json
POST /api/auth/verify-email
{
  "confirmation_token": "temp_token_abc123",
  "code": "123456"
}
```

**Ответ (успех):**
```json
{
  "message": "Email подтвержден",
  "access_token": "jwt_access_token_here",
  "refresh_token": "jwt_refresh_token_here",
  "user": {
    "id": 1,
    "email": "user@example.com",
    "name": null,
    "balance": 10
  }
}
```

**Frontend после успеха:**
1. Сохраняет tokens (localStorage или httpOnly cookie)
2. Сохраняет user data в Redux store
3. Удаляет confirmation_token
4. Redirect на `/` (главную страницу)
5. Показывает welcome snackbar

**Ответ (ошибка - неверный код):**
```json
{
  "error": "invalid_code",
  "message": "Неверный код подтверждения"
}
```

**Ответ (ошибка - код истек):**
```json
{
  "error": "code_expired",
  "message": "Код подтверждения истек. Запросите новый"
}
```

---

### 4. Повторная отправка кода

**API запрос:**
```json
POST /api/auth/request-confirmation-code
{
  "confirmation_token": "temp_token_abc123"
}
```

- Тот же эндпоинт что и для первой отправки
- Генерируется новый код
- Старый код становится недействительным
- Таймер 60 секунд между запросами (на фронтенде)

---

---

## Взаимодействия

### Автоматическая отправка кода при загрузке
1. Страница загружается с `confirmation_token`
2. Автоматически отправляем запрос на получение кода
3. Показываем snackbar: "Код отправлен на {email}"
4. Пользователь проверяет почту

### Ввод кода
1. Пользователь вводит первую цифру
2. Фокус автоматически переходит на следующее поле
3. При вводе всех 6 цифр:
   - **Вариант A:** Кнопка "Подтвердить" активируется
   - **Вариант B:** Автоматическая отправка на проверку (рекомендуется)
4. Backspace перемещает на предыдущее поле

### Проверка кода
1. Код отправляется на бекенд
2. Показываем loading на кнопке
3. **Успех:**
   - Сохраняем tokens
   - Snackbar: "Email подтвержден!"
   - Redirect на главную (автоматический вход)
4. **Ошибка:**
   - Анимация тряски полей
   - Поля краснеют и очищаются
   - Показываем сообщение об ошибке
   - Фокус на первом поле

### Повторная отправка кода
1. Нажатие "Отправить код повторно"
2. Отправка запроса с `confirmation_token`
3. Snackbar: "Новый код отправлен"
4. Таймер 60 секунд (кнопка disabled)
5. Старый код становится недействительным

### Изменение email
1. Нажатие "Изменить email"
2. Dialog/modal с полем для нового email
3. Валидация формата
4. Отправка на бекенд
5. Новый `confirmation_token`
6. Новый код на новый email
7. Обновляем отображаемый email

---

## UI компоненты
- `PinInput` / `CodeInput` - поля для ввода кода (6 цифр)
- `Button` (Primary, Text)
- `Link`
- `Snackbar` / `Toast`
- `Dialog` (для изменения email)
- `Icon` (email icon)
- `Timer` - таймер для кнопки повторной отправки

---

## Компонент PinInput

### Структура
```jsx
<PinInput
  length={6}
  value={code}
  onChange={setCode}
  onComplete={handleVerify}
  error={hasError}
  disabled={isLoading}
/>
```

### Поведение
- 6 отдельных input полей
- Type: "tel" (числовая клавиатура на мобильных)
- Pattern: [0-9]
- MaxLength: 1 для каждого поля
- Автофокус на первом поле
- Автоматический переход при вводе
- Backspace для перехода назад
- Paste support (вставка 6-значного кода из буфера)

---

## Адаптация для Desktop
- Контент в центре в карточке
- Max-width: 500px
- Больше отступов
- Поля ввода кода крупнее (легче видеть)

---

## Технические детали

### Хранение confirmation_token
```javascript
// После регистрации
const { confirmation_token, email } = registerResponse
localStorage.setItem('confirmation_token', confirmation_token)
navigate(`/confirm-email?email=${email}`)

// На странице подтверждения
const confirmationToken = localStorage.getItem('confirmation_token')
const email = searchParams.get('email')
```

### Автоматическая отправка кода при монтировании
```javascript
useEffect(() => {
  if (confirmationToken) {
    requestConfirmationCode(confirmationToken)
  }
}, [])
```

### Валидация кода
```javascript
const validateCode = (code) => {
  return /^\d{6}$/.test(code)
}
```

### Таймер повторной отправки
```javascript
const [resendTimer, setResendTimer] = useState(60)
const [canResend, setCanResend] = useState(false)

useEffect(() => {
  if (resendTimer > 0) {
    const timer = setTimeout(() => setResendTimer(resendTimer - 1), 1000)
    return () => clearTimeout(timer)
  } else {
    setCanResend(true)
  }
}, [resendTimer])

const handleResend = async () => {
  await requestConfirmationCode(confirmationToken)
  setResendTimer(60)
  setCanResend(false)
}
```

---

## API Endpoints

### 1. Запрос кода подтверждения
```
POST /api/auth/request-confirmation-code
Body: { "confirmation_token": "string" }
Response: { "message": "string", "expires_in": 600 }
```

### 2. Проверка кода
```
POST /api/auth/verify-email
Body: { 
  "confirmation_token": "string",
  "code": "string" 
}
Response: { 
  "message": "string",
  "access_token": "string",
  "refresh_token": "string",
  "user": { ... }
}
```

### 3. Изменение email (опционально)
```
POST /api/auth/change-email
Body: { 
  "confirmation_token": "string",
  "new_email": "string" 
}
Response: { 
  "message": "string",
  "new_confirmation_token": "string",
  "email": "string"
}
```

---

## Таймер действия кода
- Код действителен 10 минут (600 секунд)
- Показываем таймер на странице (опционально)
- После истечения показываем сообщение "Код истек"
- Предлагаем запросить новый код

---

## Security

### Rate Limiting
- Макс. 3 попытки ввода неверного кода
- После 3 неудачных попыток → блокировка на 5 минут
- Или требование запроса нового кода

### Защита от брутфорса
- Ограничение запросов нового кода (1 раз в минуту)
- Confirmation token имеет срок действия
- Код одноразовый (использованный код недействителен)

---

## SEO
- Title: "Подтвердите email | Felend"
- noindex, nofollow (не индексируем эту страницу)

---

## Примечания
- Не показываем эту страницу пользователям, которые вошли через Google OAuth (их email автоматически подтвержден)
- Код из 6 цифр легче запомнить и ввести чем переходить по ссылке
- Автоматический переход между полями улучшает UX
- Paste support позволяет вставить скопированный код
- После подтверждения пользователь сразу залогинен (не нужно заново вводить пароль)
- Confirmation token хранится только до подтверждения, потом удаляется
