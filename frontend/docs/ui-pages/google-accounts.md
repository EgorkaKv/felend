# Страница управления Google аккаунтами

## Назначение
Подключение, отключение и управление Google аккаунтами для доступа к Google Forms.

## Путь
`/profile/google-accounts`

## Доступ
- Только для авторизованных пользователей
- Доступ из профиля

---

## Структура страницы

### Шапка
- Кнопка "Назад" (←) → `/profile`
- Заголовок: "Google аккаунты"

---

### Информационный баннер (если нет аккаунтов)

**Alert / Info card:**
- Иконка: ℹ️
- Заголовок: "Зачем подключать Google аккаунт?"
- Текст: "Подключите Google аккаунт, чтобы добавлять свои опросы из Google Forms"
- Можно закрыть (dismiss)

---

### Основной контент

#### Список подключенных аккаунтов

**Если нет аккаунтов:**
- Empty state:
  - Иллюстрация: Google logo
  - Заголовок: "Нет подключенных аккаунтов"
  - Подзаголовок: "Подключите Google аккаунт для добавления опросов"
  - Кнопка: "Подключить аккаунт"

**Если есть аккаунты:**
- Список карточек аккаунтов

---

#### Карточка Google аккаунта

**Визуал:**
- Аватарка Google аккаунта (круглая)
- Email (основной текст)
- Имя (если доступно, под email)

**Статус:**
- Badge "Основной" (primary color)
  - Только на одном аккаунте
  - Этот аккаунт выбран по умолчанию при создании опроса

**Действия:**
- Меню три точки (⋮) или кнопки:
  
  **Для не основного аккаунта:**
  - "Сделать основным"
  - "Отключить"
  
  **Для основного аккаунта:**
  - "Отключить" (если есть другие аккаунты)
  - Нельзя отключить если это единственный аккаунт с активными опросами

---

### Кнопка добавления (внизу или вверху)

- Кнопка "+ Подключить Google аккаунт" (primary или outlined)
- Полная ширина на мобильных
- Фиксированная внизу экрана (FAB) или в конце списка

---

## Состояния

### 1. Загрузка списка аккаунтов
- Показываем skeleton карточки (2-3 штуки)

### 2. Список загружен (нет аккаунтов)
- Empty state
- Кнопка "Подключить"

### 3. Список загружен (есть аккаунты)
- Карточки с аккаунтами
- Можно взаимодействовать

### 4. Подключение нового аккаунта (OAuth flow)
- Открывается OAuth popup Google
- Текущая страница остается
- После успешной авторизации:
  - Аккаунт добавляется в список
  - Snackbar: "Аккаунт {email} подключен"
  - Если это первый аккаунт → автоматически становится основным

### 5. Отключение аккаунта
- Показываем confirmation dialog
- После подтверждения:
  - Аккаунт исчезает из списка
  - Snackbar: "Аккаунт отключен"
  - Если это был основной → другой становится основным

### 6. Смена основного аккаунта
- Нажатие "Сделать основным"
- Badge переходит на этот аккаунт
- Snackbar: "Основной аккаунт изменен"

### 7. Ошибка OAuth
- OAuth отменен или ошибка
- Snackbar: "Не удалось подключить аккаунт"
- Остаемся на странице

### 8. Ошибка отключения
- Нельзя отключить последний аккаунт с активными опросами
- Dialog:
  - "Невозможно отключить аккаунт"
  - "У вас есть активные опросы, связанные с этим аккаунтом. Завершите или удалите их перед отключением"
  - Кнопка: "Перейти к моим опросам"

---

## Взаимодействия

### Подключение нового аккаунта
1. Нажатие "+ Подключить Google аккаунт"
2. Открывается OAuth flow:
   - Popup окно Google
   - Выбор аккаунта
   - Разрешение доступа (Google Forms API, read email)
3. После успешной авторизации:
   - Redirect callback обрабатывается
   - Отправка кода на бекенд
   - Получение токенов
4. Аккаунт добавляется в список
5. Успешное уведомление

### Смена основного аккаунта
1. Нажатие "Сделать основным" в меню аккаунта
2. Отправка запроса на сервер
3. Обновление UI:
   - Badge "Основной" перемещается
   - Старый основной становится обычным
4. Snackbar подтверждение

### Отключение аккаунта
1. Нажатие "Отключить" в меню
2. Confirmation dialog:
   - "Отключить Google аккаунт?"
   - "Опросы, связанные с этим аккаунтом, могут перестать работать"
   - Кнопки: "Отмена" | "Отключить" (красная)
3. Проверка на бекенде:
   - Есть ли активные опросы?
   - Это единственный аккаунт?
4. **Успех:**
   - Аккаунт удаляется
   - Если был основной → выбирается новый основной
5. **Ошибка:**
   - Показываем причину
   - Предлагаем действия

---

## Адаптация для Desktop

- Контент в центре (max-width: 700px)
- Карточки аккаунтов более широкие
- Действия видны сразу (не в меню)

---

## UI компоненты
- `GoogleAccountCard` - карточка аккаунта
- `Badge` - badge "Основной"
- `Button` (Primary, Outlined)
- `Menu` - меню действий
- `Dialog` - confirmation dialogs
- `Snackbar` - уведомления
- `EmptyState` - пустое состояние

---

## Технические детали

### API получение списка аккаунтов
```json
GET /api/google-accounts
```

**Ответ:**
```json
{
  "accounts": [
    {
      "id": 1,
      "email": "ivan@gmail.com",
      "name": "Иван Петров",
      "avatar_url": "https://...",
      "is_primary": true,
      "connected_at": "2025-10-01T10:00:00Z"
    },
    {
      "id": 2,
      "email": "ivan.work@gmail.com",
      "name": "Иван Петров",
      "avatar_url": "https://...",
      "is_primary": false,
      "connected_at": "2025-10-15T14:30:00Z"
    }
  ]
}
```

### OAuth Flow

**Шаги подключения Google аккаунта:**

1. **Пользователь нажимает "Подключить Google аккаунт"**
   - Frontend делает запрос на бекенд: `GET /api/v1/auth/google/login`

2. **Бекенд формирует OAuth URL и делает redirect**
   - Бекенд генерирует ссылку для Google OAuth
   - Возвращает 302 redirect на Google OAuth страницу
   - Пример URL:
   ```
   https://accounts.google.com/o/oauth2/v2/auth?
     client_id=${GOOGLE_CLIENT_ID}&
     redirect_uri=${BACKEND_URL}/api/v1/auth/google/callback&
     response_type=code&
     scope=https://www.googleapis.com/auth/forms.responses.readonly email profile&
     access_type=offline&
     prompt=consent
   ```

3. **Пользователь авторизуется в Google**
   - Выбирает Google аккаунт
   - Дает разрешения приложению
   - Google редиректит на callback URL бекенда

4. **Бекенд обрабатывает callback от Google**
   - Google делает запрос: `GET /api/v1/auth/google/callback?code=...`
   - Бекенд обменивает authorization code на access/refresh токены
   - Сохраняет токены и информацию об аккаунте в БД
   - Делает 302 redirect на фронтенд: `/profile/google-accounts`

5. **Завершение на фронтенде**
   - Страница `/profile/google-accounts` загружается
   - Frontend обновляет список Google аккаунтов (делает `GET /api/v1/google-accounts`)
   - Новый аккаунт появляется в списке
   - Показывается Snackbar: "Аккаунт {email} подключен"

**Ответ (успех):**
```json
{
  "account": {
    "id": 3,
    "email": "new@gmail.com",
    "name": "New User",
    "avatar_url": "https://...",
    "is_primary": false
  }
}
```

### API смена основного аккаунта
```json
POST /api/google-accounts/{id}/set-primary
```

**Ответ:**
```json
{
  "message": "Основной аккаунт изменен"
}
```

### API отключение аккаунта
```json
DELETE /api/google-accounts/{id}
```

**Ответ (успех):**
```json
{
  "message": "Аккаунт отключен"
}
```

**Ответ (ошибка):**
```json
{
  "error": "has_active_surveys",
  "message": "У вас есть активные опросы, связанные с этим аккаунтом",
  "active_surveys_count": 3
}
```

---

## OAuth Scopes

**Необходимые разрешения:**
- `https://www.googleapis.com/auth/forms.responses.readonly` - чтение ответов форм
- `email` - email пользователя
- `profile` - имя и аватарка

---

## Security

**Хранение токенов:**
- Access token и refresh token хранятся на бекенде
- Frontend не имеет прямого доступа к токенам
- Бекенд использует токены для API запросов к Google

**Отзыв доступа:**
- При отключении аккаунта бекенд отзывает токены через Google API

---

## Примечания
- OAuth flow должен быть простым и понятным
- Четкое объяснение зачем нужны Google аккаунты
- Можно подключить несколько аккаунтов (личный + рабочий)
- Основной аккаунт выбирается по умолчанию
- Защита от случайного отключения последнего аккаунта
